{% extends "layout.html" %}

{% block body %}
    {% if current_user.is_authenticated %}
        {{ current_user }}
    {% endif %}

<div class="container">
{% if current_user.is_admin() %}
    <div id="create_task">
        <form action="/create_task" method="POST">
            Assigned to: 
            <select name="assigned_to_id" id="assigned_to_id">
            {% for u in active_users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
            {% endfor %}
            </select>
            <br/>
            Origin: <input type="text" name="origin" id="origin"/>
            <br/>
            Destination: <input type="text" name="destination" id="destination"/>
            <br/>
            Comment: <input type="text" name="comment" id="comment"/>
            <br/>
            <input type="submit" value="Create"/>
        </form>
    </div>
{% endif %}
    <button id="btn">Load</button>
    <div id="tasks" class="table-responsive"/>
</div>

<div id="start_progress_div" style="display: none;">
    <
</div>

<script id="mp_template" type="text/template">
        <table class="table table-bordered">
            <thead>
                <td>ID</td>
                <td>Created At</td>
                <td>Created By</td>
                <td>Assigned To</td>
                <td>Origin</td>
                <td>Destination</td>
                <td>Comments</td>
                <td>Status</td>
                <td>Archived</td>
                <td>Price</td>
                <td>&nbsp;</td>
            </thead>
            <tbody>
            <%#.%>
            <tr>
                <td><% id %></td>
                <td><% created_at %></td>
                <td><% created_by %></td>
                <td><% assigned_to %></td>
                <td><% origin %></td>
                <td><% destination %></td>
                <td style="white-space:pre"><% comments %></td>
                <td><% status %></td>
                <td><% archived %></td>
                <td><% price %></td>
                <td>
                    <form action="/start_progress/<% id %>" method="post"><input type="submit" value="Start progress"/></form>
                    <form action="/finish_task/<% id %>" method="post"><input type="submit" value="Finish task"/></form>
                    <form action="/archive_task/<% id %>" method="post"><input type="submit" value="Archive task"/></form>
                    <form action="/comment_task/<% id %>" method="post"><input type="submit" value="Add comment"/></form>
                </td>
            </tr>
            <%/.%>
            </tbody>
        </table>
</script>

<script>
function fetch_tasks() {
        $.getJSON('http://localhost:5000/tasks', function (tasks) {
            var template = $("#mp_template").html();
            var text = Mustache.render(template, tasks);
            $("#tasks").html(text);
        });
}

$(function () {
    $("#btn").on('click', fetch_tasks);
    fetch_tasks();
    window.setInterval(fetch_tasks, 10000);
});
</script>

{% endblock %}
